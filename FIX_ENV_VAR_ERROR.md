# Fix ENV_VAR_NOT_FOUND Error

## The Problem

You're seeing `ValueError(ERROR_MESSAGES.ENV_VAR_NOT_FOUND)` in the logs. This means OpenWebUI is missing required environment variables.

## Required Variables Checklist

Make sure ALL of these are set in your Render dashboard:

### ✅ Critical OAuth Variables (Must Have):

1. **MICROSOFT_CLIENT_ID**
   - Your Azure app's Client ID
   - Get from: Azure Portal → App registrations → Your app → Overview

2. **MICROSOFT_CLIENT_SECRET** ⚠️ **MOST LIKELY MISSING**
   - Your Azure app's Client Secret VALUE
   - Get from: Azure Portal → App registrations → Your app → Certificates & secrets
   - **This is probably what's missing!**

3. **MICROSOFT_TENANT_ID**
   - Your Azure Directory (tenant) ID
   - Get from: Azure Portal → App registrations → Your app → Overview

4. **MICROSOFT_REDIRECT_URI**
   - Should be: `https://glchemtec-openwebui.onrender.com/oauth/microsoft/callback`
   - (Update with your actual Render URL)
   - **Must match exactly** what you set in Azure

5. **OPENID_PROVIDER_URL**
   - Format: `https://login.microsoftonline.com/YOUR_TENANT_ID/v2.0/.well-known/openid-configuration`
   - Replace `YOUR_TENANT_ID` with your actual tenant ID

### ✅ Required General Variables:

6. **WEBUI_URL**
   - Your Render service URL: `https://glchemtec-openwebui.onrender.com`
   - (Update with your actual URL)

7. **WEBUI_SECRET_KEY**
   - Auto-generated by Render (or set manually)
   - Used for session security

8. **OPENAI_API_KEY**
   - Your OpenAI API key

### ✅ Recommended Variables:

9. **WEBUI_AUTH** = `true` (forces login)
10. **ENABLE_OAUTH_SIGNUP** = `true` (allows Microsoft signups)
11. **ENABLE_LOGIN_FORM** = `true` (keeps username/password option)
12. **ENABLE_OAUTH_PERSISTENT_CONFIG** = `true` (saves OAuth settings)
13. **MICROSOFT_OAUTH_SCOPE** = `openid email profile`

## How to Fix

### Step 1: Check Render Environment Variables

1. Go to your Render dashboard
2. Click on your `glchemtec-openwebui` service
3. Go to **Environment** tab
4. Check if **MICROSOFT_CLIENT_SECRET** is set
   - If missing, add it now!

### Step 2: Verify All Variables

Make sure these are all present:
- [ ] OPENAI_API_KEY
- [ ] MICROSOFT_CLIENT_ID
- [ ] MICROSOFT_CLIENT_SECRET ⚠️ **Check this one!**
- [ ] MICROSOFT_TENANT_ID
- [ ] WEBUI_URL
- [ ] MICROSOFT_REDIRECT_URI
- [ ] OPENID_PROVIDER_URL
- [ ] WEBUI_SECRET_KEY (auto-generated)

### Step 3: Update OPENID_PROVIDER_URL

If you created a new Azure app with a new Tenant ID:
- Update `OPENID_PROVIDER_URL` to use your new tenant ID:
  ```
  https://login.microsoftonline.com/YOUR_NEW_TENANT_ID/v2.0/.well-known/openid-configuration
  ```

### Step 4: Redeploy

After adding/updating variables:
1. Save all environment variables in Render
2. Trigger a manual redeploy (or wait for auto-deploy)
3. Check logs again

## Common Issues

### Issue: "MICROSOFT_CLIENT_SECRET not found"
**Fix:** Add it in Render → Environment → Add `MICROSOFT_CLIENT_SECRET` with your secret value

### Issue: "OPENID_PROVIDER_URL incorrect"
**Fix:** Make sure it uses your actual tenant ID:
```
https://login.microsoftonline.com/YOUR_TENANT_ID/v2.0/.well-known/openid-configuration
```

### Issue: "MICROSOFT_REDIRECT_URI mismatch"
**Fix:** 
- In Render: Should be `https://YOUR-URL.onrender.com/oauth/microsoft/callback`
- In Azure: Must match exactly (same URL)

### Issue: Variables set but still error
**Fix:**
- Check for typos (case-sensitive!)
- Make sure no extra spaces
- Restart/redeploy the service
- Check logs for which specific variable is missing

## Quick Test

After fixing, check the logs. You should see:
- ✅ No `ENV_VAR_NOT_FOUND` errors
- ✅ Service starts successfully
- ✅ OAuth endpoints are accessible

## Still Having Issues?

Share the exact error message from the logs (which variable is missing), and I can help you fix it!
